<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp AI å®¢æˆ¶ç«¯ - Kimi</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #667eea; --primary-dark: #5a67d8;
      --success: #48bb78; --warning: #ed8936; --error: #f56565;
      --bg: #f7fafc; --card-bg: #ffffff; --text: #2d3748;
      --text-secondary: #718096; --border: #e2e8f0;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
    .container { display: flex; height: 100vh; }
    .sidebar { width: 300px; background: var(--card-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
    .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
    .sidebar-header h1 { font-size: 18px; color: var(--primary); }
    .connection-form { padding: 20px; border-bottom: 1px solid var(--border); }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 5px; }
    .form-group input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
    .form-group input:focus { outline: none; border-color: var(--primary); }
    .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .status-panel { padding: 20px; flex: 1; overflow-y: auto; }
    .status-item { display: flex; align-items: center; gap: 10px; padding: 10px; margin-bottom: 10px; background: var(--bg); border-radius: 8px; font-size: 13px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; }
    .status-dot.connected { background: var(--success); }
    .status-dot.disconnected { background: var(--error); }
    .status-dot.connecting { background: var(--warning); animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .main { flex: 1; display: flex; flex-direction: column; }
    .chat-header { padding: 15px 25px; background: var(--card-bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .chat-header h2 { font-size: 16px; font-weight: 600; }
    .model-selector { display: flex; align-items: center; gap: 10px; }
    .model-selector select { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; }
    .messages { flex: 1; overflow-y: auto; padding: 20px; }
    .message { max-width: 80%; margin-bottom: 20px; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message.user { margin-left: auto; }
    .message-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; margin-bottom: 5px; }
    .message.user .message-avatar { background: var(--primary); color: white; margin-left: auto; }
    .message.assistant .message-avatar { background: #10a37f; color: white; }
    .message-content { padding: 12px 16px; border-radius: 12px; font-size: 14px; line-height: 1.6; white-space: pre-wrap; }
    .message.user .message-content { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
    .message.assistant .message-content { background: var(--card-bg); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
    .message-time { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
    .message.user .message-time { text-align: right; }
    .tool-result { background: #f0fff4; border: 1px solid #9ae6b4; border-radius: 8px; padding: 12px; margin-top: 10px; font-family: monospace; font-size: 12px; overflow-x: auto; }
    .tool-result-header { display: flex; align-items: center; gap: 6px; margin-bottom: 8px; color: #22543d; font-weight: 600; }
    .tool-result pre { margin: 0; white-space: pre-wrap; word-break: break-word; }
    .input-area { padding: 20px; background: var(--card-bg); border-top: 1px solid var(--border); }
    .input-container { display: flex; gap: 10px; align-items: flex-end; }
    .input-wrapper { flex: 1; position: relative; }
    .input-wrapper textarea { width: 100%; min-height: 50px; max-height: 150px; padding: 12px 15px; border: 1px solid var(--border); border-radius: 12px; font-size: 14px; resize: none; font-family: inherit; }
    .input-wrapper textarea:focus { outline: none; border-color: var(--primary); }
    .send-btn { width: 50px; height: 50px; border-radius: 12px; background: var(--primary); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .send-btn:hover { background: var(--primary-dark); }
    .send-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .typing-indicator { display: flex; gap: 4px; padding: 12px 16px; }
    .typing-indicator span { width: 8px; height: 8px; background: var(--text-secondary); border-radius: 50%; animation: bounce 1.4s infinite; }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); }
    .empty-state h3 { font-size: 18px; margin-bottom: 10px; }
    .quick-actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .quick-action { padding: 6px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 16px; font-size: 12px; cursor: pointer; }
    .quick-action:hover { background: var(--primary); color: white; }
    .error-message { background: #fed7d7; color: #c53030; padding: 12px 16px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>ğŸ¤– WhatsApp AI</h1>
      </div>
      <div class="connection-form">
        <div class="form-group">
          <label>æ‰‹æ©Ÿè™Ÿç¢¼</label>
          <input type="text" id="phoneInput" placeholder="85212345678" value="85297188675">
        </div>
        <div class="form-group">
          <label>Kimi API Key <span id="apiKeyStatus" style="color: var(--text-secondary);">â—‹ æœªè¼‰å…¥</span></label>
          <input type="password" id="apiKeyInput" placeholder="è‡ªå‹•å¾ä¼ºæœå™¨è¼‰å…¥...">
        </div>
        <button class="btn btn-primary" id="connectBtn" onclick="toggleConnection()">é€£æ¥</button>
      </div>
      <div class="status-panel">
        <div class="status-item">
          <div class="status-dot disconnected" id="apiStatus"></div>
          <span>WhatsApp API</span>
        </div>
        <div class="status-item">
          <div class="status-dot disconnected" id="kimiStatus"></div>
          <span>Kimi AI</span>
        </div>
        <div style="margin-top: 20px; padding: 10px; background: var(--bg); border-radius: 8px; font-size: 12px; color: var(--text-secondary);">
          <strong>å¯ç”¨åŠŸèƒ½ï¼š</strong>
          <ul style="margin: 8px 0 0 16px; line-height: 1.8;">
            <li>ğŸ“‹ åˆ—å‡ºèŠå¤©</li>
            <li>ğŸ’¬ æŸ¥çœ‹è¨Šæ¯</li>
            <li>ğŸ‘¤ æœå°‹è¯çµ¡äºº</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="chat-header">
        <h2>ğŸ’¬ èˆ‡ Kimi AI å°è©±</h2>
        <div class="model-selector">
          <label>æ¨¡å‹ï¼š</label>
          <select id="modelSelect">
            <option value="kimi-latest">Kimi Latest</option>
            <option value="kimi-k2-0711-preview">Kimi K2</option>
          </select>
        </div>
      </div>
      <div class="messages" id="messages">
        <div class="empty-state">
          <h3>ğŸ‘‹ æ­¡è¿ä½¿ç”¨ WhatsApp AI å®¢æˆ¶ç«¯</h3>
          <p>è«‹å…ˆè¼¸å…¥ API Key ä¸¦é€£æ¥</p>
        </div>
      </div>
      <div class="input-area">
        <div id="errorContainer"></div>
        <div class="quick-actions">
          <span class="quick-action" onclick="sendQuickMessage('åˆ—å‡ºæœ€è¿‘çš„èŠå¤©')">ğŸ“‹ æœ€è¿‘èŠå¤©</span>
          <span class="quick-action" onclick="sendQuickMessage('æœ‰ä»€éº¼è¯çµ¡äºº')">ğŸ‘¤ è¯çµ¡äºº</span>
          <span class="quick-action" onclick="sendQuickMessage('é¡¯ç¤ºé€£æ¥ç‹€æ…‹')">ğŸ“¡ ç‹€æ…‹</span>
        </div>
        <div class="input-container" style="margin-top: 10px;">
          <div class="input-wrapper">
            <textarea id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯...ï¼ˆæŒ‰ Enter ç™¼é€ï¼‰" onkeydown="handleKeyDown(event)" disabled></textarea>
          </div>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== State ====================
    let isConnected = false;
    let messages = [];

    // ==================== API Functions ====================
    const API_BASE = '/api';
    
    async function apiCall(endpoint, options = {}) {
      const phone = document.getElementById('phoneInput').value.trim();
      const url = `${API_BASE}${endpoint}${endpoint.includes('?') ? '&' : '?'}phone=${phone}`;
      const response = await fetch(url, options);
      if (!response.ok) throw new Error(`API error: ${response.status}`);
      return response.json();
    }

    // Direct API calls replacing MCP tools
    async function listChats() {
      return apiCall('/chats');
    }

    async function listMessages(chatJid) {
      return apiCall(`/messages?chat_jid=${encodeURIComponent(chatJid)}`);
    }

    async function listContacts() {
      return apiCall('/contacts');
    }

    async function getHealth() {
      return apiCall('/health');
    }

    // ==================== Kimi API ====================
    async function callKimi(userMessage) {
      const apiKey = document.getElementById('apiKeyInput').value.trim();
      if (!apiKey) throw new Error('è«‹è¼¸å…¥ Kimi API Key');

      const model = document.getElementById('modelSelect').value;
      
      const tools = [
        {
          type: 'function',
          function: {
            name: 'list_chats',
            description: 'åˆ—å‡ºç”¨æˆ¶çš„ WhatsApp èŠå¤©åˆ—è¡¨',
            parameters: { type: 'object', properties: {} }
          }
        },
        {
          type: 'function',
          function: {
            name: 'list_messages',
            description: 'åˆ—å‡ºç‰¹å®šèŠå¤©çš„è¨Šæ¯',
            parameters: {
              type: 'object',
              properties: {
                chat_jid: { type: 'string', description: 'èŠå¤©çš„ JID' }
              },
              required: ['chat_jid']
            }
          }
        },
        {
          type: 'function',
          function: {
            name: 'list_contacts',
            description: 'åˆ—å‡ºç”¨æˆ¶çš„ WhatsApp è¯çµ¡äºº',
            parameters: { type: 'object', properties: {} }
          }
        },
        {
          type: 'function',
          function: {
            name: 'get_status',
            description: 'ç²å– API é€£æ¥ç‹€æ…‹',
            parameters: { type: 'object', properties: {} }
          }
        }
      ];

      const response = await fetch('https://api.moonshot.cn/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model,
          messages: [
            {
              role: 'system',
              content: `ä½ æ˜¯ä¸€å€‹ WhatsApp åŠ©æ‰‹ã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚

ç•¶ç”¨æˆ¶å•åŠèŠå¤©ã€è¨Šæ¯ã€è¯çµ¡äººæ™‚ï¼Œè«‹èª¿ç”¨ç›¸æ‡‰å·¥å…·ã€‚

èŠå¤©JIDæ ¼å¼ï¼š
- å€‹äºº: 8529xxxxxxxx@s.whatsapp.net
- ç¾¤çµ„: xxxxxxxxxx@g.us`
            },
            ...messages.filter(m => m.role).map(m => ({ role: m.role, content: m.content })),
            { role: 'user', content: userMessage }
          ],
          tools,
          tool_choice: 'auto'
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error?.message || 'Kimi API error');
      }

      return response.json();
    }

    // ==================== UI Functions ====================
    function updateStatus(id, status) {
      document.getElementById(id).className = 'status-dot ' + status;
    }

    function showError(msg) {
      const el = document.getElementById('errorContainer');
      el.innerHTML = `<div class="error-message">${msg}</div>`;
      setTimeout(() => el.innerHTML = '', 5000);
    }

    function addMessage(content, role, toolResult = null) {
      const container = document.getElementById('messages');
      if (container.querySelector('.empty-state')) container.innerHTML = '';

      const id = `msg_${Date.now()}`;
      const time = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
      
      const el = document.createElement('div');
      el.className = `message ${role}`;
      el.id = id;
      
      const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
      let html = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content">${escapeHtml(content)}</div>
        <div class="message-time">${time}</div>
      `;

      if (toolResult) {
        html += `
          <div class="tool-result">
            <div class="tool-result-header">ğŸ”§ API çµæœ</div>
            <pre>${escapeHtml(JSON.stringify(toolResult, null, 2))}</pre>
          </div>
        `;
      }

      el.innerHTML = html;
      container.appendChild(el);
      container.scrollTop = container.scrollHeight;
      messages.push({ id, role, content, toolResult, time });
      return id;
    }

    function showTyping() {
      const container = document.getElementById('messages');
      const id = 'typing_' + Date.now();
      const el = document.createElement('div');
      el.className = 'message assistant';
      el.id = id;
      el.innerHTML = `
        <div class="message-avatar">ğŸ¤–</div>
        <div class="message-content">
          <div class="typing-indicator"><span></span><span></span><span></span></div>
        </div>
      `;
      container.appendChild(el);
      container.scrollTop = container.scrollHeight;
      return id;
    }

    function removeTyping(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function handleKeyDown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    function sendQuickMessage(text) {
      document.getElementById('messageInput').value = text;
      sendMessage();
    }

    // ==================== Main Logic ====================
    async function toggleConnection() {
      const btn = document.getElementById('connectBtn');
      
      if (isConnected) {
        isConnected = false;
        btn.textContent = 'é€£æ¥';
        updateStatus('apiStatus', 'disconnected');
        updateStatus('kimiStatus', 'disconnected');
        document.getElementById('messageInput').disabled = true;
        document.getElementById('sendBtn').disabled = true;
      } else {
        btn.disabled = true;
        btn.textContent = 'é€£æ¥ä¸­...';
        updateStatus('apiStatus', 'connecting');
        
        try {
          // Test API connection
          await getHealth();
          updateStatus('apiStatus', 'connected');
          
          // Test Kimi API
          updateStatus('kimiStatus', 'connecting');
          const apiKey = document.getElementById('apiKeyInput').value.trim();
          if (!apiKey) throw new Error('è«‹è¼¸å…¥ Kimi API Key');
          
          // Quick test of Kimi API
          const testResp = await fetch('https://api.moonshot.cn/v1/models', {
            headers: { 'Authorization': `Bearer ${apiKey}` }
          });
          if (!testResp.ok) throw new Error('Kimi API Key ç„¡æ•ˆ');
          
          updateStatus('kimiStatus', 'connected');
          isConnected = true;
          btn.textContent = 'æ–·é–‹';
          document.getElementById('messageInput').disabled = false;
          document.getElementById('sendBtn').disabled = false;
          document.getElementById('messageInput').focus();
        } catch (error) {
          showError(`é€£æ¥å¤±æ•—: ${error.message}`);
          updateStatus('apiStatus', 'disconnected');
          updateStatus('kimiStatus', 'disconnected');
        } finally {
          btn.disabled = false;
        }
      }
    }

    async function executeTool(functionName, args) {
      switch (functionName) {
        case 'list_chats': return await listChats();
        case 'list_messages': return await listMessages(args.chat_jid);
        case 'list_contacts': return await listContacts();
        case 'get_status': return await getHealth();
        default: throw new Error(`Unknown tool: ${functionName}`);
      }
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text) return;
      
      input.value = '';
      addMessage(text, 'user');
      const typingId = showTyping();
      
      try {
        const response = await callKimi(text);
        removeTyping(typingId);
        
        const choice = response.choices[0];
        
        if (choice.message.tool_calls?.length > 0) {
          for (const toolCall of choice.message.tool_calls) {
            const name = toolCall.function.name;
            const args = JSON.parse(toolCall.function.arguments);
            
            try {
              const result = await executeTool(name, args);
              addMessage(choice.message.content || `åŸ·è¡Œ: ${name}`, 'assistant', result);
            } catch (err) {
              addMessage(`éŒ¯èª¤: ${err.message}`, 'assistant');
            }
          }
        } else {
          addMessage(choice.message.content, 'assistant');
        }
      } catch (error) {
        removeTyping(typingId);
        addMessage(`éŒ¯èª¤: ${error.message}`, 'assistant');
      }
    }

    // ==================== Load Config ====================
    async function loadConfig() {
      try {
        const response = await fetch('/api/config');
        const config = await response.json();
        
        if (config.openrouterKey) {
          document.getElementById('apiKeyInput').value = config.openrouterKey;
          document.getElementById('apiKeyStatus').textContent = 'âœ“ å·²è¼‰å…¥';
          document.getElementById('apiKeyStatus').style.color = 'var(--success)';
        }
      } catch (e) {
        console.log('Config load failed:', e);
      }
    }

    // ==================== Init ====================
    document.addEventListener('DOMContentLoaded', () => {
      loadConfig();
    });
  </script>
</body>
</html>
